<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="description" content="allergen-information-detection">
  <meta name="keywords" content="HTML, CSS, JavaScript">
  <meta name="author" content="Bhumika and Abhisha">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
  <title>NutriSafe</title>
</head>
<body>
  <div class="header">
    <a href="#default" class="logo"><img src="logo.png" alt="NutriSafe Logo" width="70" height="60"></a>
    <div class="header-right">
      <a class="active" href="#home">Home</a>
      <a href="about.html">About</a>
      <a href="GotoProfile.html">Profile</a>
    </div>
  </div>

  <div class="info">
    <p>Find if a product is the right choice for you!</p>
    <div class="description">
      <p>Use our Ingredient Safety Checker to find out if the food item you want to purchase is allergy friendly</p>
      <p>Just upload a photo of the ingredient label and find out if it's safe to consume!</p>
    </div>
  </div>

  <div class="image-upload">
    <div class="file-upload-background">
      <label class="file-upload">
        <input type="file" name="myfile" id="file-upload">Choose Image<br><br>
      </label>
      <label id="file-name"></label>
    </div>
    <div class="container">
      <button id="submit">Upload</button>
    </div>
  </div>

  <div id="loader" style="display:none;">Loading...</div>

  <div id="hidden-response" style="display:none;">
    <div class="ingredient">
      <p id="desp">The list of ingredients are - </p>
      <p id="response1"></p>
      <p id="desp">Is this item safe for consumption?</p>
      <p id="response2"></p>
      <p id="desp">How should you store this item?</p>
      <p id="response3"></p>
      <p id="desp">Try these alternatives!</p>
      <p id="response4"></p>
    </div>
  </div>

  <script type="importmap">
    {
      "imports": {
        "@google/generative-ai": "https://esm.run/@google/generative-ai"
      }
    }
  </script>

  <script type="module">
    import { GoogleGenerativeAI } from "@google/generative-ai";
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
    apiKey: "AIzaSyD7iDZ6I1tsAiEGyv_h7up8nfYkAWB0hHU",
    authDomain: "biology-dfa72.firebaseapp.com",
    databaseURL: "https://biology-dfa72-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "biology-dfa72",
    storageBucket: "biology-dfa72.appspot.com",
    messagingSenderId: "295125268878",
    appId: "1:295125268878:web:6b0f65caa52c46c14f0cdf",
    measurementId: "G-QGDMJ1G3PP"
  };
    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);

    const auth = getAuth();
    const db = getDatabase();

    // Helper function to convert file to base64
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result.split(',')[1]);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // Function to generate content using GoogleGenerativeAI
    async function generateContent(model, prompt, imageParts) {
      try {
        const result = await model.generateContent([prompt, ...imageParts]);
        const response = await result.response;
        return response.text();
      } catch (error) {
        console.error('Error generating content:', error);
      }
    }

    onAuthStateChanged(auth, (user) => {
      if (user) {
        console.log("User is signed in:", user);
        const uid = user.uid;
        const userRef = ref(db, 'users/' + uid);
        get(userRef).then((snapshot) => {
          if (snapshot.exists()) {
            console.log("User data exists");
            const username = snapshot.val().username;
            const profileRef = ref(db, 'CustomerSet/' + username);
            get(profileRef).then((snapshot) => {
              if (snapshot.exists()) {
                console.log("Customer data exists");
                const data = snapshot.val();
                const allergens = Object.keys(data.allergy)
                  .filter(key => data.allergy[key])
                  .map(key => key.replace(/([A-Z])/g, ' $1').trim())
                  .join(', ');

                const fileInput = document.querySelector("#file-upload");
                const fileNameLabel = document.querySelector("#file-name");
                const submitButton = document.getElementById("submit");
                const hiddenContent = document.getElementById('hidden-response');
                const loaderSymbol = document.getElementById('loader');

                fileInput.addEventListener("change", function () {
                  fileNameLabel.textContent = this.files[0].name;
                  console.log("File selected:", this.files[0].name);
                });

                const API_KEY = "AIzaSyD7iDZ6I1tsAiEGyv_h7up8nfYkAWB0hHU";
                const genAI = new GoogleGenerativeAI(API_KEY);
                const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });

                submitButton.addEventListener("click", async function () {
                  console.log("Upload button clicked");
                  if (fileInput.files.length === 0) {
                    alert("Please choose an image file.");
                    return;
                  }

                  loaderSymbol.style.display = 'block';

                  try {
                    const file = fileInput.files[0];
                    const imagePart = { inlineData: { data: await fileToBase64(file), mimeType: file.type } };
                    console.log("Image converted to base64");

                    let prompt = "List all the ingredients in this label, with each ingredient in a new line. No other text apart from the ingredients.";
                    let text = await generateContent(model, prompt, [imagePart]);
                    document.getElementById("response1").innerHTML = text.replace(/\n/g, "<li>");
                    console.log("Response 1 generated:", text);

                    prompt = `List of things I do not eat - ${allergens}. If it is safe to eat, just say yes. If it is not, say no and state the reason why in 2 sentences.`;
                    text = await generateContent(model, prompt, [imagePart]);
                    document.getElementById("response2").innerHTML = text;
                    console.log("Response 2 generated:", text);

                    prompt = "Identify the type of food item and provide detailed instructions on how to store the food item to avoid health risks.";
                    text = await generateContent(model, prompt, [imagePart]);
                    document.getElementById("response3").innerHTML = text.replace(/\n/g, "<br>");
                    console.log("Response 3 generated:", text);

                    prompt = "Identify the food item or type of food item that the list of ingredients is for. Classify it as highly processed food, natural/not processed food and slightly processed food. Based on the food item, suggest 3 other healthy recipes similar to the food item. Reply in plain text";
                    text = await generateContent(model, prompt, [imagePart]);
                    document.getElementById("response4").innerHTML = text.replace(/\n/g, "<br>");
                    console.log("Response 4 generated:", text);

                  } catch (error) {
                    console.error("Error during processing:", error);
                  } finally {
                    loaderSymbol.style.display = 'none';
                    hiddenContent.style.display = 'block';
                    console.log("Processing complete, hidden content displayed");
                  }
                });

              } else {
                alert("Customer data doesn't exist");
                console.log("Customer data doesn't exist");
              }
            }).catch((error) => {
              console.error("Error fetching profile data: ", error);
            });
          } else {
            console.log("No user data available");
          }
        }).catch((error) => {
          console.error("Error fetching username: ", error);
        });
      } else {
        console.log("User is signed out");
        window.location.href = 'about.html'; // Redirect to login page if not authenticated
      }
    });
  </script>
</body>
</html>
